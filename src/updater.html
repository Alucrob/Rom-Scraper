<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROM Scraper — Update</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep:    #111112;
  --bg-panel:   #111318;
  --bg-card:    #181B23;
  --bg-input:   #1E2130;
  --accent:     #FF4D2E;
  --accent2:    #FF7A5C;
  --text-pri:   #F0F2FF;
  --text-sec:   #8A91B0;
  --text-dim:   #444A6A;
  --border:     #252A3A;
  --success:    #2ECC8A;
  --error:      #FF4D2E;
  --mono: 'IBM Plex Mono', monospace;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }

body {
  background: var(--bg-deep);
  color: var(--text-pri);
  font-family: var(--mono);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  user-select: none;
  -webkit-app-region: drag;
}

.updater-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 32px 36px;
  width: 400px;
  text-align: center;
  -webkit-app-region: no-drag;
}

.logo {
  width: 48px; height: 48px;
  background: var(--accent);
  border-radius: 10px;
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: #fff;
  box-shadow: 0 0 24px rgba(255,77,46,0.4);
  margin-bottom: 16px;
}

.title {
  font-size: 14px; font-weight: 700; letter-spacing: 3px;
  text-transform: uppercase; margin-bottom: 4px;
}

.subtitle {
  font-size: 10px; color: var(--text-sec); letter-spacing: 1px;
  margin-bottom: 20px;
}

.version-row {
  display: flex; justify-content: center; align-items: center; gap: 12px;
  margin-bottom: 20px; font-size: 11px;
}

.ver-tag {
  padding: 4px 10px;
  border-radius: 4px;
  font-weight: 600; letter-spacing: 0.5px;
}

.ver-current { background: var(--bg-input); color: var(--text-sec); border: 1px solid var(--border); }
.ver-new { background: rgba(255,77,46,0.1); color: var(--accent); border: 1px solid rgba(255,77,46,0.3); }
.ver-arrow { color: var(--text-dim); font-size: 14px; }

.release-notes {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 10px; color: var(--text-sec);
  text-align: left; line-height: 1.6;
  margin-bottom: 20px;
  max-height: 80px; overflow-y: auto;
}

/* ── Progress Bar ── */
.progress-container {
  display: none;
  margin-bottom: 16px;
}

.progress-container.active { display: block; }

.progress-bar-bg {
  width: 100%; height: 8px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 4px;
  width: 0%;
  transition: width 0.3s ease;
}

.progress-text {
  display: flex; justify-content: space-between;
  font-size: 9px; color: var(--text-sec); letter-spacing: 0.5px;
}

.progress-percent {
  color: var(--accent); font-weight: 600;
}

/* ── Status message ── */
.status-msg {
  font-size: 10px;
  color: var(--text-sec);
  margin-bottom: 16px;
  min-height: 16px;
  letter-spacing: 0.5px;
}

.status-msg.error { color: var(--error); }
.status-msg.success { color: var(--success); }

/* ── Buttons ── */
.btn-row {
  display: flex; gap: 10px; justify-content: center;
}

.btn {
  padding: 10px 20px;
  border: none; border-radius: 6px;
  font-family: var(--mono); font-size: 10px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase;
  cursor: pointer; transition: all 0.15s;
}

.btn:disabled {
  opacity: 0.4; cursor: not-allowed;
}

.btn-primary {
  background: var(--accent); color: #fff;
  box-shadow: 0 0 16px rgba(255,77,46,0.3);
}
.btn-primary:hover:not(:disabled) { background: #e6442a; box-shadow: 0 0 24px rgba(255,77,46,0.5); }

.btn-ghost {
  background: transparent; color: var(--text-sec);
  border: 1px solid var(--border);
}
.btn-ghost:hover:not(:disabled) { background: var(--bg-input); color: var(--text-pri); }

.btn-success {
  background: var(--success); color: #111;
  box-shadow: 0 0 16px rgba(46,204,138,0.3);
}
.btn-success:hover:not(:disabled) { background: #27b87a; }
</style>
</head>
<body>

<div class="updater-card">
  <div class="logo">RS</div>
  <div class="title">Update Available</div>
  <div class="subtitle">A new version of ROM Scraper is ready</div>

  <div class="version-row">
    <span class="ver-tag ver-current" id="verCurrent">v—</span>
    <span class="ver-arrow">→</span>
    <span class="ver-tag ver-new" id="verNew">v—</span>
  </div>

  <div class="release-notes" id="releaseNotes">Loading release notes...</div>

  <div class="progress-container" id="progressContainer">
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>
    <div class="progress-text">
      <span id="progressDetail">0 MB / 0 MB</span>
      <span class="progress-percent" id="progressPercent">0%</span>
    </div>
  </div>

  <div class="status-msg" id="statusMsg"></div>

  <div class="btn-row" id="btnRow">
    <button class="btn btn-ghost" id="btnSkip" onclick="skipUpdate()">Later</button>
    <button class="btn btn-primary" id="btnDownload" onclick="startDownload()">Download &amp; Install</button>
    <button class="btn btn-success" id="btnInstall" onclick="installNow()" style="display:none;">Install &amp; Restart</button>
  </div>
</div>

<script>
function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}

function formatSpeed(bytesPerSec) {
  if (bytesPerSec < 1024) return bytesPerSec + ' B/s';
  if (bytesPerSec < 1048576) return (bytesPerSec / 1024).toFixed(0) + ' KB/s';
  return (bytesPerSec / 1048576).toFixed(1) + ' MB/s';
}

// Strip HTML tags from release notes (GitHub sends HTML)
function stripHtml(html) {
  if (!html) return '';
  return html.replace(/<[^>]*>/g, '').trim();
}

// Receive version info
window.updaterAPI.onUpdateStatus((data) => {
  document.getElementById('verCurrent').textContent = 'v' + data.currentVersion;
  document.getElementById('verNew').textContent = 'v' + data.newVersion;
  const notes = typeof data.releaseNotes === 'string'
    ? stripHtml(data.releaseNotes)
    : (data.releaseNotes || []).map(n => stripHtml(n.note || n)).join('\n');
  document.getElementById('releaseNotes').textContent = notes || 'See GitHub for details.';
});

// User clicks "Download & Install"
function startDownload() {
  document.getElementById('btnDownload').disabled = true;
  document.getElementById('btnDownload').textContent = 'DOWNLOADING...';
  document.getElementById('btnSkip').disabled = true;
  document.getElementById('progressContainer').classList.add('active');
  document.getElementById('statusMsg').textContent = 'Starting download...';
  document.getElementById('statusMsg').className = 'status-msg';

  window.updaterAPI.startDownload();
}

// Receive download progress
window.updaterAPI.onUpdateProgress((data) => {
  const pct = Math.round(data.percent);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressPercent').textContent = pct + '%';

  const detail = formatBytes(data.transferred) + ' / ' + formatBytes(data.total);
  const speed = data.bytesPerSecond ? ' — ' + formatSpeed(data.bytesPerSecond) : '';
  document.getElementById('progressDetail').textContent = detail + speed;

  document.getElementById('statusMsg').textContent = 'Downloading update... ' + pct + '%';
});

// Download complete
window.updaterAPI.onUpdateComplete(() => {
  document.getElementById('progressFill').style.width = '100%';
  document.getElementById('progressPercent').textContent = '100%';
  document.getElementById('statusMsg').textContent = 'Download complete! Ready to install.';
  document.getElementById('statusMsg').className = 'status-msg success';

  // Hide download button, show install button
  document.getElementById('btnDownload').style.display = 'none';
  document.getElementById('btnInstall').style.display = '';
  document.getElementById('btnSkip').disabled = false;
  document.getElementById('btnSkip').textContent = 'LATER';
});

// Error
window.updaterAPI.onUpdateError((data) => {
  document.getElementById('statusMsg').textContent = 'Update error: ' + (data.message || 'Unknown error');
  document.getElementById('statusMsg').className = 'status-msg error';
  document.getElementById('btnDownload').disabled = false;
  document.getElementById('btnDownload').textContent = 'RETRY DOWNLOAD';
  document.getElementById('btnSkip').disabled = false;
});

// User clicks "Install & Restart"
function installNow() {
  document.getElementById('btnInstall').disabled = true;
  document.getElementById('btnInstall').textContent = 'INSTALLING...';
  document.getElementById('btnSkip').disabled = true;
  document.getElementById('statusMsg').textContent = 'Installing update and restarting...';
  window.updaterAPI.installUpdate();
}

// User clicks "Later"
function skipUpdate() {
  window.updaterAPI.skipUpdate();
}
</script>
</body>
</html>
