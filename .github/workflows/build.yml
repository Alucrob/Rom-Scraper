build-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Fix dmg-builder color bug
        run: |
          python3 << 'EOF'
          import os, glob
          # Locate the internal core.py file that handles the color parsing
          core_file = 'node_modules/dmg-builder/vendor/dmgbuild/core.py'
          
          if os.path.exists(core_file):
              with open(core_file, 'r') as f:
                  content = f.read()
              
              # The crashing line in your error log is: c = parseColor(background_color).to_rgb()
              # We replace it with a safe version that defaults to black if the parse fails.
              old_line = 'c = parseColor(background_color).to_rgb()'
              new_line = 'try:\n        c = parseColor(background_color).to_rgb()\n    except:\n        c = (10, 11, 15)'
              
              if old_line in content:
                  new_content = content.replace(old_line, new_line)
                  with open(core_file, 'w') as f:
                      f.write(new_content)
                  print(f"Successfully patched {core_file}")
              else:
                  print("Target line not found, check version compatibility.")
          else:
              print(f"File not found: {core_file}")
          EOF

      - name: Build Mac DMG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:mac

      - name: Upload Mac artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-installer
          path: dist/ROM-Scraper-*.dmg
